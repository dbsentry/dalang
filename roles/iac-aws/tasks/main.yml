---
#############################################################################
#                       Confidentiality Information                         #
#                                                                           #
# This module is the confidential and proprietary information of            #
# DBSentry Corp.; it is not to be copied, reproduced, or transmitted in any #
# form, by any means, in whole or in part, nor is it to be used for any     #
# purpose other than that for which it is expressly provided without the    #
# written permission of DBSentry Corp.                                      #
#                                                                           #
# Copyright (c) 2020-2021 DBSentry Corp.  All Rights Reserved.              #
#                                                                           #
#############################################################################
## Create/Deletes AWS Infrastructure
#############################################################################
- name: Set tf_directory
  set_fact:
    tf_directory: "{{ playbook_dir }}/terraform/{{ aws_account_name }}"

- name: Create list of terraform template folders
  block:
    - name: Initialize an empty list
      set_fact:
        tf_blast_radius_tmp: []

    - name: Find folders for terraform templates
      find:
        paths: "{{ tf_directory }}"
        file_type: "directory"
      register: dirlist

    - debug:
        msg: "{{ dirlist.files | map(attribute='path') | list | sort }}"
        verbosity: 1

    - name: Parse Folders
      set_fact:
        tf_blast_radius_tmp: "{{ tf_blast_radius_tmp + [ item | basename ] }}"
      loop: "{{ dirlist.files | map(attribute='path') | list | sort }}"

    - name: Set tf_blast_radius
      set_fact:
        tf_blast_radius: "{{ tf_blast_radius_tmp }}"
  when: tf_blast_radius_all in tf_blast_radius

- name: AWS Infrastructure. Target State - {{ tf_target_state }}
  include: terraform.yml tf_stack="{{ item }}"
  loop: "{{ tf_blast_radius }}"